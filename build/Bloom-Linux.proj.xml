<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<RootDir>$(MSBuildProjectDirectory)/..</RootDir>
		<Solution>Bloom VS2010.sln</Solution>
		<ApplicationName>Bloom</ApplicationName>
		<Configuration>Release</Configuration>
		<BUILD_NUMBER>1.0.1</BUILD_NUMBER>
	</PropertyGroup>
	<PropertyGroup Condition="'$(OS)'=='Windows_NT'">
		<useNUnit-x86>true</useNUnit-x86>
	</PropertyGroup>
	<PropertyGroup Condition="'$(OS)'!='Windows_NT'">
		<useNUnit-x86>false</useNUnit-x86>
	</PropertyGroup>

	<UsingTask TaskName="StampAssemblies" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="MakeWixForDirTree" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="CpuArchitecture" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="Split" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="FileUpdate" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="DownloadFile" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="NUnit" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="NUnitTeamCity"
		AssemblyFile="$(agent_home_dir)/plugins/dotnetPlugin/bin/JetBrains.BuildServer.MSBuildLoggers.dll"
		Condition="'$(TEAMCITY_VERSION)' != ''"/>

	<Target Name="Init">
		<CpuArchitecture>
			<Output TaskParameter="Value" PropertyName="arch"/>
		</CpuArchitecture>
	</Target>

	<Target Name="VersionNumbers">
		<Message Text="BUILD_NUMBER: $(BUILD_NUMBER)" Importance="high" />
		<Split Input="$(BUILD_NUMBER)" Delimiter="." OutputSubString="2">
			<Output TaskParameter="ReturnValue" PropertyName="BuildCounter" />
		</Split>
		<Message Text="BuildCounter: $(BuildCounter)" Importance="high" />
		<!-- Note, after some thought, we've decided this is the best place to keep the
			version number (not on TeamCity, not in the assemblies).     -->
		<CreateProperty Value="1.0.$(BuildCounter)">
			<Output PropertyName="Version" TaskParameter="Value" />
		</CreateProperty>
		<Message Text="Version: $(Version)" Importance="high" />
	</Target>

	<ItemGroup>
		<AssemblyInfoFiles Include="$(RootDir)/src/**/AssemblyInfo.cs" />
	</ItemGroup>
	<Target Name="SetAssemblyVersion" DependsOnTargets="VersionNumbers">
		<StampAssemblies Version="$(Version)" InputAssemblyPaths="@(AssemblyInfoFiles)" />
	</Target>

	<Target Name="Build" DependsOnTargets="SetAssemblyVersion; Init">
		<MSBuild Projects="$(RootDir)/$(Solution)" Targets="Rebuild" Properties="Configuration=$(Configuration)" />
	</Target>

	<Target Name="Test" DependsOnTargets="GetXulRunnerIntoLib; Build;">
		<CreateItem Include="$(RootDir)/output/$(Configuration)/*Tests.dll">
			<Output ItemName="TestAssemblies" TaskParameter="Include" />
		</CreateItem>
		<NUnitTeamCity Assemblies="@(TestAssemblies)"
			ExcludeCategory="SkipOnTeamCity"
			NUnitVersion="NUnit-2.6.2"
			ContinueOnError="ErrorAndStop"
			Condition="'$(TEAMCITY_VERSION)' != ''"/>
		<NUnit Assemblies="@(TestAssemblies)"
			ToolPath="$(RootDir)/packages/NUnit.Runners.2.6.3/tools"
			WorkingDirectory="$(RootDir)/output/$(Configuration)"
			Force32Bit="$(useNUnit-x86)"
			OutputXmlFile="$(RootDir)/output/$(Configuration)/TestResults.xml"
			ContinueOnError="ErrorAndStop"
			Condition="'$(TEAMCITY_VERSION)' == ''"/>
	</Target>

	<Target Name="DownloadDistFiles">
		<Message Text="Downloading Bloom.chm help file" Importance="high" />
		<DownloadFile Address="https://dl.dropboxusercontent.com/s/wbhocwhrb2unflc/Bloom.chm?token_hash=AAFkMXoM2OfGoPCx8nF1d3DwLWFAbTZz1wIbF4V5s8EKOQamp;dl=1"
			LocalFileName="$(RootDir)/DistFiles/Bloom.chm"/>
	</Target>

	<Target Name="GetXulRunnerIntoLib" DependsOnTargets="Init">
		<Message Text="Downloading XulRunner..." Importance="high" />
		<MakeDir Directories="$(RootDir)/Downloads"/>
		<DownloadFile Address="http://ftp.mozilla.org/pub/mozilla.org/xulrunner/releases/14.0b12/runtimes/xulrunner-14.0b12.en-US.linux-$(arch).tar.bz2"
			LocalFileName="$(RootDir)/Downloads/xulrunner-14.0b12.tar.bz2"
			Condition="!Exists('$(RootDir)/Downloads/xulrunner-14.0b12.tar.bz2')"/>
		<Exec Command="tar xfj $(RootDir)/Downloads/xulrunner-14.0b12.tar.bz2"
			WorkingDirectory="$(RootDir)/lib"
			Condition="!Exists('$(RootDir)/lib/xulrunner')"/>
	</Target>
</Project>
